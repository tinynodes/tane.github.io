<!DOCTYPE html>
<html  lang="en-gb" >
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="generator" content="Hugo 0.80.0" />
  
  <title>tane.dev - Development tutorials for modern web development</title>

  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,800" rel="stylesheet" />
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-6jHF7Z3XI3fF4XZixAuSu0gGKrXwoX/w3uFPxC56OtjChio7wtTGJWRW53Nhx6Ev" crossorigin="anonymous" />






<link rel="stylesheet" href="https://tane.dev/css/bundle.min.860283af9f116f9e7c3c8b30f173a99265c0c653f5153cad9acf7f7465eb99635ab360987470fdeb8539e964c6b7e239a14f432d044b9cac92ac28af741c4e4a.css" integrity="sha512-hgKDr58Rb558PIsw8XOpkmXAxlP1FTytms9/dGXrmWNas2CYdHD964U56WTGt&#43;I5oU9DLQRLnKySrCivdBxOSg==" />


  <link rel="alternate" type="application/rss&#43;xml" href="https://tane.dev/index.xml" title="tane.dev" />
  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://tane.dev/images/social_generic.jpg"/>

<meta name="twitter:title" content="tane.dev"/>
<meta name="twitter:description" content="Development tutorials for modern web development"/>

  <meta property="og:image" content="https://www.mugshotbot.com/m?url=https://tane.dev/"/>
</head>


  <body class="light">

    <div class="container-left">

<div class="row">
  <div class="column sidebar">
    <div class="sidebar-content">
  <h1
    class="site-title flex-item flex-start"
    title="The title of the site tane.dev - click it to go back to the homepage"
    aria-label="The title of the site tane.dev - click it to go back to the homepage"
  >
    <a href="https://tane.dev" title="Click here to go back to the home page">tane.dev</a>
  </h1>
  <h2
    class="flex-item subtitle"
    title="The subtitle of the site, is has a brain in it which makes the assumption the author has one"
    aria-label="The subtitle of the site, is has a brain in it which makes the assumption the author has one"
  >
    [ <i class="far fa-head-side-brain"></i> ideas <sup>&amp; stuff</sup> ]
  </h2>

  

  <aside class="menu">
    <ul class="sidebar-menus menu-list">
      
    </ul>

    <h3 class="menu-label" title="A recent list of posts I've somehow managed to write down">
      <i class="far fa-keyboard"></i> Recent Posts:
    </h3>

    <ul class="previous-posts">
      
      <li>
        <a href="https://tane.dev/2021/01/web-serial-api-with-rxjs-two-way-reactive-communication-between-browser-and-serial-hardware/">Web Serial API with RxJS - Two-Way Reactive Communication between Browser and Serial Hardware</a> 


<span>Published: Jan 30, 2021</span>

      </li>
      
      <li>
        <a href="https://tane.dev/2021/01/create-your-own-dark-mode-detection-observable-using-rxjs-and-media-queries/">Create your own Dark Mode Detection Observable using RxJS and Media Queries</a> 


<span>Published: Jan 27, 2021</span>

      </li>
      
      <li>
        <a href="https://tane.dev/2021/01/creating-custom-rxjs-operators/">Creating Custom RxJS Operators</a> 


<span>Published: Jan 25, 2021</span>

      </li>
      
      <li>
        <a href="https://tane.dev/2021/01/rxjs-ninja-updates-new-operators-for-math-and-working-with-streams/">RxJS Ninja Updates - New operators for math and working with streams</a> 


<span>Published: Jan 14, 2021</span>

      </li>
      
      <li>
        <a href="https://tane.dev/2020/11/rxjs-primitives-is-now-rxjs-ninja/">RxJS Primitives is now RxJS Ninja</a> 


<span>Published: Nov 23, 2020</span>

      </li>
      
    </ul>
    <div class="feed">
      <a href="https://tane.dev/index.xml"><i class="far fa-rss-square"></i>&nbsp;RSS Feed</a>
    </div>
  </aside>
  <div class="service-buttons">
  <div class="flex-item button-group-label">Links:</div>
  
    <a class="flex-item" href="https://github.com/tanepiper" title="Link to my Github" target="_new"><i class='fab fa-github-alt'></i></a>
  
    <a class="flex-item" href="https://linkedin.com/in/tanepiper" title="Link to my LinkedIn" target="_new"><i class='fab fa-linkedin'></i></a>
  
    <a class="flex-item" href="https://twitter.com/tanepiper" title="Link to my Twitter" target="_new"><i class='fab fa-twitter'></i></a>
  
</div>

  <footer class="footer">
  <div class="flex-item contact">
    
    <i class="far fa-copyright"></i>&nbsp;2021 Tane Piper
    

    
    <a href="mailto:" title="I promise I check this from time to time" aria-label="I promise I check this from time to time"><i class="far fa-mailbox"></i>&nbsp;Email into the void</a>
    
  </div>
  <div class="flex-item meta">
    <div><i class="fas fa-hammer"></i>&nbsp;Site built with <a href="http://gohugo.io">Hugo</a> 0.80.0 <a href="https://tane.dev/about" title="Click on this link to go to the about page"><sup>[about]</sup></a></div>
    <div><i class="far fa-business-time"></i> Last modified 2021-01-31 20:21</div>
  </div>
</footer>

  <div class="theme-buttons">
  <div class="flex-item button-group-label">Theme:</div>
  <button class="flex-item btn btn-circle btn-theme btn-light" data-theme="light" title="Click this button for the light theme" aria-label="Click this button for the light theme" />
  <button class="flex-item btn btn-circle btn-theme btn-dark" data-theme="dark" title="Click this button for the dark theme" aria-label="Click this button for the dark theme" />
  <button class="flex-item btn btn-circle btn-theme btn-darkgreen" data-theme="darkgreen" title="Click this button for the darkgreen theme" aria-label="Click this button for the darkgreen theme" />
</div>

</div>

<style type="text/css">
  .previous-posts li {
    flex-direction: column;
  }

  .previous-posts li span {
    margin-left: .5rem;
    border-left: 1px solid #d3d3d3;
    justify-content: right;
  }
</style>

  </div>

  <main class="column main">
    

    
    <div class="post">
  <div class="post-heading">
    <h1>
      <a href="https://tane.dev/2021/01/web-serial-api-with-rxjs-two-way-reactive-communication-between-browser-and-serial-hardware/">Web Serial API with RxJS - Two-Way Reactive Communication between Browser and Serial Hardware</a>
    </h1>
    
      <div class="meta">
  <i class="far fa-calendar-edit" title="The date when this post was originally published" aria-label="The date when this post was originally published"></i><span>&nbsp;Published: Jan 30, 2021</span>
  
  &nbsp;<span title="The date I last noticed a typo" aria-label="The date I last noticed a typo">(last updated: Jan 30, 2021)</span>
  
  |&nbsp;<i class="far fa-pencil" title="The number of semi-coherent words I managed to produce" aria-label="The number of semi-coherent words I managed to produce"></i><span>~ 1100 words</span>
  |&nbsp;<i class="far fa-clock" title="Time is an illusion. Lunchtime doubly so" aria-label="Time is an illusion. Lunchtime doubly so"></i><span>~ 5 minutes reading time</span>
</div>

      
  <div class="tags" title="Click the links in this to go to a page based on a tag value" aria-label="Click the links in this to go to a page based on a tag value">
    
    <a class="flex-item" href="https://tane.dev/tags/typescript">TypeScript</a>
    
    <a class="flex-item" href="https://tane.dev/tags/rxjs">RxJS</a>
    
    <a class="flex-item" href="https://tane.dev/tags/observables">Observables</a>
    
    <a class="flex-item" href="https://tane.dev/tags/web-serial">Web Serial</a>
    
    <a class="flex-item" href="https://tane.dev/tags/ecmascript">ECMAScript</a>
    
    <a class="flex-item" href="https://tane.dev/tags/tutorial">Tutorial</a>
    
  </div>


      
        <div class="comments-link">
  <i
    class="far fa-comment-alt-lines"
    title="Read what the trolls have posted..."
    aria-label="Read what the trolls have posted..."
  ></i>&nbsp;<a href="https://tane.dev/2021/01/web-serial-api-with-rxjs-two-way-reactive-communication-between-browser-and-serial-hardware/#commento">... comments</a>
</div>

      
    
  </div>
  <div class="post-content"><ul>
<li><a href="https://rxjs-from-web-serial.stackblitz.io/" target="_blank">Demo Link</a>
</li>
<li><a href="https://stackblitz.com/edit/rxjs-from-web-serial?file=index.ts" target="_blank">Demo Source</a>
</li>
</ul>
<p>Version 89 of Chrome and Edge browsers have released the <a href="https://reillyeon.github.io/serial/" target="_blank">Web Serial API</a>
 unflagged
which means as user it&rsquo;s now available for general use rather than being locked behind experimental flags (if you&rsquo;re
on an earlier version you can enable <strong>Experimental Web Platform features</strong> in <code>chrome://flags</code>)</p>
<p>The API allows for communication between the browser and supported serial hardware such
as <a href="https://www.arduino.cc/" target="_blank">Arduino</a>
 or <a href="https://www.raspberrypi.org/" target="_blank">RaspberryPi</a>
 over USB Serial.</p>
<p>If you don&rsquo;t have any hardware to connect to, you can use Bluetooth Serial - provided your computer has a Bluetooth
module. Connect your mobile device to it and use the appropriate software. For Android there
is  <a href="https://play.google.com/store/apps/details?id=de.kai_morich.serial_bluetooth_terminal&amp;hl=en&amp;gl=US" target="_blank">Serial Bluetooth Terminal</a>

and iOS <a href="https://apps.apple.com/us/app/ble-to-serial-terminal/id1238004134" target="_blank">BLE to Serial Terminal</a>
.</p>
<h2 id="connecting-to-a-serial-device">Connecting to a serial device</h2>
<p>To request access to a device, a call needs to be made to <code>navigator.serial.requestPort</code> - This call <strong>must</strong> be made
after a user gesture such as a button click - you cannot just call <code>requestPort</code> from your code without some kind of
user interaction as this will cause a security violation. You also must call it from a location that does not have
policy set up to disable this (you can see this in the demo above - if you try run it in the editor it won&rsquo;t work due to
the <code>&lt;iframe&gt;</code> not having the correct policy).</p>
<p>You may also need to install the <a href="https://www.npmjs.com/package/@types/w3c-web-serial" target="_blank">w3c-web-serial types</a>
 in your
project to make sure you have the available types on the <code>navigator</code> object and global types such as <code>SerialPort</code>.</p>
<p>To get a port, call <code>navigator.serial.requestPort</code> inside the handler - it will return a Promise that contains the port
object - you can also wrap it in a <code>try/catch</code> to handle when the user cancels device selection.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">startButton</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;start&#34;</span>);

<span style="color:#a6e22e">startButton</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#34;click&#34;</span>, <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">event</span> <span style="color:#f92672">=&gt;</span> {
  <span style="color:#66d9ef">try</span> {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">port</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">navigator</span>.<span style="color:#a6e22e">serial</span>.<span style="color:#a6e22e">requestPort</span>();
    <span style="color:#75715e">// We can now access the serial device by opening it
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// e.g. await port.open({baudRate: 9600})
</span><span style="color:#75715e"></span>  } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">e</span>) {
    <span style="color:#75715e">// The prompt has been dismissed without selecting a device.
</span><span style="color:#75715e"></span>  }
});
</code></pre></td></tr></table>
</div>
</div><p>The port object once created must be called with the <code>open</code> method - the only required property of the options is the
<code>baudRate</code> which is the maximum bits-per-second transferred but there
are <a href="https://reillyeon.github.io/serial/#open-method" target="_blank">other options</a>
 based on the requirements of the device.</p>
<p>Once opened the port can return a <a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream" target="_blank">ReadableStream</a>

and <a href="https://developer.mozilla.org/en-US/docs/Web/API/WritableStream" target="_blank">WritableStream</a>
 which allows data to be passed to
and from the device.</p>
<h2 id="our-rxjs-operator">Our RxJS Operator</h2>
<p>To turn this into an RxJS operator we&rsquo;ll consume the port and set up the functionality to both read and write to the
serial bus. You
can <a href="https://github.com/rxjs-ninja/rxjs-ninja/blob/main/libs/rxjs/utility/src/lib/from-web-serial.ts" target="_blank">read the full source code</a>

to see how the final Observable was created, but we&rsquo;ll cover the important sections below.</p>
<h2 id="reading-from-the-serial-bus">Reading from the Serial Bus</h2>
<p>Once connected, the serial device can start sending data to us - as it&rsquo;s a <code>ReadableStream</code> the result will be
a <code>UInt8Array</code>.</p>
<p>Here we&rsquo;ll set up an iterable reader for our stream - while the result is not <code>done</code> and the port is still readable,
we&rsquo;ll continue to read the source and emit it to the subscriber of the Observable. If the reader has completed, or the
port has been closed we&rsquo;ll end this iteration.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">await</span> <span style="color:#a6e22e">port</span>.<span style="color:#a6e22e">open</span>({<span style="color:#a6e22e">baudRate</span>: <span style="color:#66d9ef">9600</span>});

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">process</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (
  <span style="color:#a6e22e">result</span>: <span style="color:#66d9ef">ReadableStreamReadResult</span>&lt;<span style="color:#f92672">Uint8Array</span>&gt;
)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">ReadableStreamReadResult</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">Uint8Array</span>&gt;<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=&gt;</span> {
  <span style="color:#a6e22e">subscriber</span>.<span style="color:#a6e22e">next</span>(<span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">value</span>);
  <span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">done</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">port</span>.<span style="color:#a6e22e">readable</span>
    <span style="color:#f92672">?</span> <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">read</span>().<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">process</span>)
    <span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>.<span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">result</span>);
};

<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">port</span>.<span style="color:#a6e22e">readable</span>) {
  <span style="color:#a6e22e">reader</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">port</span>.<span style="color:#a6e22e">readable</span>.<span style="color:#a6e22e">getReader</span>();
  <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">read</span>().<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">process</span>);
}
</code></pre></td></tr></table>
</div>
</div><p>As the output of our Observable is a <code>Uint8Array</code>. Depending on your needs you can decode this to the format you need,
but in most cases it will be text content - here we can use
a <a href="https://developer.mozilla.org/en-US/docs/Web/API/TextDecoder" target="_blank">TextDecoder</a>
 to get the value:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">decoder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">TextDecoder</span>(<span style="color:#e6db74">&#34;utf-8&#34;</span>);

<span style="color:#a6e22e">fromWebSerial</span>(<span style="color:#a6e22e">port</span>).<span style="color:#a6e22e">pipe</span>(
  <span style="color:#a6e22e">tap</span>(<span style="color:#a6e22e">value</span> <span style="color:#f92672">=&gt;</span> {
    <span style="color:#75715e">// Value is a UInt8Array, we can append to a element by decoding it
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">outputEl</span>.<span style="color:#a6e22e">innerHTML</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">decoder</span>.<span style="color:#a6e22e">decode</span>(<span style="color:#a6e22e">value</span>)
  })
).<span style="color:#a6e22e">subscribe</span>()
</code></pre></td></tr></table>
</div>
</div><h2 id="writing-to-the-serial-bus">Writing to the Serial Bus</h2>
<p>The API also allows for writing data to the device, here we can use another <code>Observable</code> that emits a string and provide
it to our function as a source, then we can hook it up to the ports <code>WritableStream</code>.</p>
<p>Instead of directly writing, we will create
a <a href="https://developer.mozilla.org/en-US/docs/Web/API/TransformStream" target="_blank">TextEncoderStream</a>
 - this allows us to create a new
internal writer that we have more control over - it contains both a reader and writer we use this to connect our
sources.</p>
<p>The reader from our encoder will be piped to the ports <code>WritableStream</code>, and the writer passed
to <a href="https://github.com/rxjs-ninja/rxjs-ninja/blob/main/libs/rxjs/utility/src/lib/to-writable-stream.ts" target="_blank">toWritableStream</a>

which connects the <code>Observable</code> to the writer:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">writerSource</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">port</span>.<span style="color:#a6e22e">writable</span>) {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">encoder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">TextEncoderStream</span>();
  <span style="color:#a6e22e">writerEnd</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">encoder</span>.<span style="color:#a6e22e">readable</span>.<span style="color:#a6e22e">pipeTo</span>(<span style="color:#a6e22e">port</span>.<span style="color:#a6e22e">writable</span>);
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">outputStream</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">encoder</span>.<span style="color:#a6e22e">writable</span>;

  <span style="color:#a6e22e">writer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">outputStream</span>.<span style="color:#a6e22e">getWriter</span>();
  <span style="color:#a6e22e">writerSource</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">toWritableStream</span>(<span style="color:#a6e22e">writer</span>, <span style="color:#a6e22e">signal</span>)).<span style="color:#a6e22e">subscribe</span>();
}
</code></pre></td></tr></table>
</div>
</div><p>Now we can pass the <code>Observable</code> and use it to emit our values:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">emitter$</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Subject</span>&lt;<span style="color:#f92672">string</span>&gt;();

<span style="color:#a6e22e">fromWebSerial</span>(<span style="color:#a6e22e">port</span>, <span style="color:#a6e22e">emitter$</span>.<span style="color:#a6e22e">asObservable</span>()).<span style="color:#a6e22e">subscribe</span>();

<span style="color:#a6e22e">emitter$</span>.<span style="color:#a6e22e">next</span>(<span style="color:#e6db74">&#39;Hello There!&#39;</span>);
</code></pre></td></tr></table>
</div>
</div><h2 id="creating-a-serial-chat-app">Creating a Serial Chat App</h2>
<p>Now we can read from, and write to, our hardware device
the <a href="https://github.com/svendahlstrand/web-serial-api" target="_blank">possibilities are endless</a>
 with what we can do - provided the
hardware supports it.</p>
<p>For this tutorial I build a <a href="https://rxjs-from-web-serial.stackblitz.io/" target="_blank">very basic chat app</a>
 - using the Bluetooth
Serial applications mentioned above you can use it to send and receive text data between devices.</p>
<p><img src="https://tane.dev/images/web-serial-mobile.jpg" alt="A screenshot of a web serial mobile app">
<img src="https://tane.dev/images/web-serial-browser.png" alt="A screenshot of a web serial browser app"></p>
<p>In the <a href="https://stackblitz.com/edit/rxjs-from-web-serial?file=index.ts" target="_blank">example code</a>
 I&rsquo;ve set up a button to enable
our port request - you should see a popup with a list of devices available for you to use. After connecting
a basic chat interface will show up - type in some text and check out your device software - you should see the same
message there, and you can then send a message back to the browser.</p>
<p>Hopefully you&rsquo;ve found this tutorial useful and if you do build something with this I&rsquo;d love to hear about it!</p>
<h2 id="a-collection-of-pre-built-operators-and-observables-for-your-projects">A collection of pre-built operators and Observables for your projects</h2>
<p><img src="https://raw.githubusercontent.com/rxjs-ninja/rxjs-ninja/main/assets/logo.png" alt="The RxJS Logo, a Ninja jumping over a moon"></p>
<p><a href="https://rxjs.ninja" target="_blank">RxJS Ninja</a>
 - is a collection of over 130 operators for working with various types of data (such
as <a href="https://rxjs.ninja/modules/array.html" target="_blank">arrays</a>
, <a href="https://rxjs.ninja/modules/number.html" target="_blank">numbers</a>
) and
<a href="https://rxjs.ninja/modules/utility.html#Streams" target="_blank">streams</a>
 allowing for modifying, filtering and querying the data.</p>
<p>Still in active development, you might find useful operators that provide clearer intent for your RxJS code.</p>
<p>You can check out the source code on <a href="https://github.com/rxjs-ninja/rxjs-ninja" target="_blank">GitHub</a>
.</p>
</div>
</div>

    
    <div class="post">
  <div class="post-heading">
    <h1>
      <a href="https://tane.dev/2021/01/create-your-own-dark-mode-detection-observable-using-rxjs-and-media-queries/">Create your own Dark Mode Detection Observable using RxJS and Media Queries</a>
    </h1>
    
      <div class="meta">
  <i class="far fa-calendar-edit" title="The date when this post was originally published" aria-label="The date when this post was originally published"></i><span>&nbsp;Published: Jan 27, 2021</span>
  
  &nbsp;<span title="The date I last noticed a typo" aria-label="The date I last noticed a typo">(last updated: Jan 27, 2021)</span>
  
  |&nbsp;<i class="far fa-pencil" title="The number of semi-coherent words I managed to produce" aria-label="The number of semi-coherent words I managed to produce"></i><span>~ 1100 words</span>
  |&nbsp;<i class="far fa-clock" title="Time is an illusion. Lunchtime doubly so" aria-label="Time is an illusion. Lunchtime doubly so"></i><span>~ 5 minutes reading time</span>
</div>

      
  <div class="tags" title="Click the links in this to go to a page based on a tag value" aria-label="Click the links in this to go to a page based on a tag value">
    
    <a class="flex-item" href="https://tane.dev/tags/typescript">TypeScript</a>
    
    <a class="flex-item" href="https://tane.dev/tags/rxjs">RxJS</a>
    
    <a class="flex-item" href="https://tane.dev/tags/observables">Observables</a>
    
    <a class="flex-item" href="https://tane.dev/tags/media-query">Media Query</a>
    
    <a class="flex-item" href="https://tane.dev/tags/ecmascript">ECMAScript</a>
    
    <a class="flex-item" href="https://tane.dev/tags/tutorial">Tutorial</a>
    
  </div>


      
        <div class="comments-link">
  <i
    class="far fa-comment-alt-lines"
    title="Read what the trolls have posted..."
    aria-label="Read what the trolls have posted..."
  ></i>&nbsp;<a href="https://tane.dev/2021/01/create-your-own-dark-mode-detection-observable-using-rxjs-and-media-queries/#commento">... comments</a>
</div>

      
    
  </div>
  <div class="post-content"><p><a href="https://stackblitz.com/edit/rxjs-media-query-observable" target="_blank">Demo Link</a>
</p>
<p>One of the more recent features available in browsers is ability to
do <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Media_Queries/Using_media_queries" target="_blank">CSS Media Queries</a>
 based on user
theme &amp; accessibility settings in the operating system - for example using <code>@media (prefers-color-scheme: dark)</code>
(see <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@media/prefers-color-scheme" target="_blank">prefers-color-scheme</a>
)
you can check if the users OS theme is currently in Dark Mode and use this to set a websites theme accordingly.</p>
<p>The query is also available in JavaScript using
the <a href="https://developer.mozilla.org/en-us/docs/Web/API/Window/matchMedia" target="_blank">window.matchMedia</a>
 function - that returns a
<code>MediaListQuery</code> that will allow us to do two things:</p>
<ul>
<li>The current value of the users setting via the <code>matches</code> boolean property</li>
<li>Any future values by listening to its <code>changes</code> event and attaching an event lister function to it</li>
</ul>
<p>Combining these, it&rsquo;s the perfect candidate to turn into a
<a href="https://stackblitz.com/edit/rxjs-media-query-observable" target="_blank">fully reactive dark mode switcher</a>

using <a href="https://rxjs.dev" target="_blank">RxJS</a>
 and Observables that will give us the users current setting.  If you&rsquo;re not familiar with
Observables, they are a type of stream that emits values over time - consumers can subscribe to these Observables to get
their values - this means we can use them to get values from long running functions or event emitters.</p>
<p>In the full demo you&rsquo;ll find an example page with light and dark mode set from your own OS settings. To see the full
working example you need to change the setting (e.g. in OSX Dark Mode is under &ldquo;General&rdquo; settings) - also provided are a
user toggle button, and a button to turn off and on the media query listener. The Observable in this example supports
more than one <code>prefers-</code> type of query but in the tutorial below we&rsquo;ll build a much simpler <code>isDarkMode</code> Observable than
the one provided in the demo, but the concept is the same.</p>
<h2 id="creating-a-dark-mode-observable">Creating a Dark Mode Observable</h2>
<p>For our code we first need to create our Observable factory - this is our function that allows us to pass any required
parameters for the implementation and returns an Observable which can then be subscribed to.</p>
<p>The Observable constructor takes a function - a callback any time there is a new subscription - this is where the
implementation will live.</p>
<p>As soon as the subscription opens, we first check to see if <code>window.matchMedia</code> is available - it should be available in
all modern browsers but is not available in environments like node (yay unit testing!) - so here we can throw an error.</p>
<p>The factory also accepts an optional <a href="https://developer.mozilla.org/en-us/docs/Web/API/AbortSignal" target="_blank">AbortSignal</a>
, an
object that contains an <code>onabort</code> callback - the parent of the signal is
a <a href="https://developer.mozilla.org/en-US/docs/Web/API/AbortController" target="_blank">AbortController</a>
 and using this we can externally
signal our Observable to close all subscriptions and remove all event listeners.</p>
<p>The return value of the constructor is another function - the teardown logic - this is called when an RxJS subscription
is ended, such as using <code>takeUntil</code> or <code>take(1)</code> - here we also ensure that all subscriptions and event listeners are
closed.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Observable</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;rxjs&#39;</span>;

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">isDarkMode</span>(<span style="color:#a6e22e">signal?</span>: <span style="color:#66d9ef">AbortSignal</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Observable</span>&lt;<span style="color:#f92672">boolean</span>&gt; {
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Observable</span>&lt;<span style="color:#f92672">boolean</span>&gt;(<span style="color:#a6e22e">subscriber</span> <span style="color:#f92672">=&gt;</span> {

    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>window.<span style="color:#a6e22e">matchMedia</span>) {
      <span style="color:#a6e22e">subscriber</span>.<span style="color:#a6e22e">error</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;No windows Media Match available&#39;</span>));
    }

    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">signal</span>) {
      <span style="color:#a6e22e">signal</span>.<span style="color:#a6e22e">onabort</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
        <span style="color:#f92672">!</span><span style="color:#a6e22e">subscriber</span>.<span style="color:#a6e22e">closed</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">subscriber</span>.<span style="color:#a6e22e">complete</span>()
      }
    }

    <span style="color:#66d9ef">return</span> () <span style="color:#f92672">=&gt;</span> {
      <span style="color:#f92672">!</span><span style="color:#a6e22e">subscriber</span>.<span style="color:#a6e22e">closed</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">subscriber</span>.<span style="color:#a6e22e">complete</span>()
    }
  });
}
</code></pre></td></tr></table>
</div>
</div><h3 id="adding-the-media-query">Adding the Media Query</h3>
<p>The main implementation of our Observable is to create our <code>MediaListQuery</code> and use it to emit values to any
subscribers. On creation, contain a <code>matches</code> value of <code>true</code> or <code>false</code> which can be immediately be passed to
<code>subscriber.next</code>.</p>
<p>We also need to bind a listener using to the <code>change</code> event of the query. As we also need to remove this later create an
internal private function for the event handler - this will also call <code>subscriber.next</code> each time there is a detected
change.</p>
<p>Also casting the event to a <code>MediaQueryListEvent</code> ensures TypeScript recognises it has the <code>matches</code> property which
contains our value.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">emitValue</span>(<span style="color:#a6e22e">event</span>: <span style="color:#66d9ef">Event</span>) {
  <span style="color:#a6e22e">subscriber</span>.<span style="color:#a6e22e">next</span>((<span style="color:#a6e22e">event</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">MediaQueryListEvent</span>).<span style="color:#a6e22e">matches</span>);
}

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">mediaListQuery</span> <span style="color:#f92672">=</span> window.<span style="color:#a6e22e">matchMedia</span>(<span style="color:#e6db74">&#39;(prefers-color-scheme: dark)&#39;</span>);
<span style="color:#a6e22e">mediaListQuery</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;change&#39;</span>, <span style="color:#a6e22e">emitValue</span>);
<span style="color:#a6e22e">subscriber</span>.<span style="color:#a6e22e">next</span>(<span style="color:#a6e22e">mediaListQuery</span>.<span style="color:#a6e22e">matches</span>);
</code></pre></td></tr></table>
</div>
</div><h3 id="cleaning-up-handlers-and-subscriptions">Cleaning up handlers and subscriptions</h3>
<p>Already we can start to use the new Observable, but we also need to make sure that we:</p>
<ul>
<li>End any subscriptions to the Observable when either the <code>AbortSignal</code> fires or RxJS unsubscribes from it</li>
<li>Remove any event listeners in the DOM for the <code>change</code> event</li>
</ul>
<p>With a slight bit of refactoring we have our final Observable factory below - in both the <code>signal.onabort</code> and the
Observable teardown logic we remove the event listener - the API for this requires you pass the function implementation
from our private function.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Observable</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;rxjs&#39;</span>;

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">isDarkMode</span>(<span style="color:#a6e22e">signal?</span>: <span style="color:#66d9ef">AbortSignal</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Observable</span>&lt;<span style="color:#f92672">boolean</span>&gt; {
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Observable</span>&lt;<span style="color:#f92672">boolean</span>&gt;(<span style="color:#a6e22e">subscriber</span> <span style="color:#f92672">=&gt;</span> {

    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>window.<span style="color:#a6e22e">matchMedia</span>) {
      <span style="color:#a6e22e">subscriber</span>.<span style="color:#a6e22e">error</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;No windows Media Match available&#39;</span>));
    }

    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">emitValue</span>(<span style="color:#a6e22e">event</span>: <span style="color:#66d9ef">Event</span>) {
      <span style="color:#a6e22e">subscriber</span>.<span style="color:#a6e22e">next</span>((<span style="color:#a6e22e">event</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">MediaQueryListEvent</span>).<span style="color:#a6e22e">matches</span>);
    }

    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">mediaListQuery</span> <span style="color:#f92672">=</span> window.<span style="color:#a6e22e">matchMedia</span>(<span style="color:#e6db74">&#39;(prefers-color-scheme: dark)&#39;</span>);

    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">signal</span>) {
      <span style="color:#a6e22e">signal</span>.<span style="color:#a6e22e">onabort</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
        <span style="color:#a6e22e">mediaListQuery</span>.<span style="color:#a6e22e">removeEventListener</span>(<span style="color:#e6db74">&#39;change&#39;</span>, <span style="color:#a6e22e">emitValue</span>)
        <span style="color:#f92672">!</span><span style="color:#a6e22e">subscriber</span>.<span style="color:#a6e22e">closed</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">subscriber</span>.<span style="color:#a6e22e">complete</span>()
      }
    }

    <span style="color:#a6e22e">mediaListQuery</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;change&#39;</span>, <span style="color:#a6e22e">emitValue</span>);
    <span style="color:#a6e22e">subscriber</span>.<span style="color:#a6e22e">next</span>(<span style="color:#a6e22e">mediaListQuery</span>.<span style="color:#a6e22e">matches</span>);

    <span style="color:#66d9ef">return</span> () <span style="color:#f92672">=&gt;</span> {
      <span style="color:#a6e22e">mediaListQuery</span>.<span style="color:#a6e22e">removeEventListener</span>(<span style="color:#e6db74">&#39;change&#39;</span>, <span style="color:#a6e22e">emitValue</span>);
      <span style="color:#f92672">!</span><span style="color:#a6e22e">subscriber</span>.<span style="color:#a6e22e">closed</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">subscriber</span>.<span style="color:#a6e22e">complete</span>()
    }
  })
}
</code></pre></td></tr></table>
</div>
</div><h3 id="finishing-up">Finishing up</h3>
<p>Now we have a fully working reactive Observable for a Dark Mode media query, this can be used in any application or
website to check the users theme setting. The <a href="https://stackblitz.com/edit/rxjs-media-query-observable" target="_blank">demo</a>
 provides
some more example of how to do this in full.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#a6e22e">isDarkMode</span>().<span style="color:#a6e22e">pipe</span>(
  <span style="color:#a6e22e">tap</span>(<span style="color:#a6e22e">value</span> <span style="color:#f92672">=&gt;</span> {
    <span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">classList</span>.<span style="color:#a6e22e">removeClass</span>(<span style="color:#a6e22e">value</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;light&#39;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;dark&#39;</span>);
    <span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">classList</span>.<span style="color:#a6e22e">addClass</span>(<span style="color:#a6e22e">value</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;dark&#39;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;light&#39;</span>);
  })
).<span style="color:#a6e22e">subscribe</span>()
</code></pre></td></tr></table>
</div>
</div><p>This tutorial is just one small example of the kind of things that can be done with RxJS - any API that can emit
values over time can be turned into Observables.</p>
<h2 id="a-collection-of-pre-built-operators-and-observables-for-your-projects">A collection of pre-built operators and Observables for your projects</h2>
<p><img src="https://raw.githubusercontent.com/rxjs-ninja/rxjs-ninja/main/assets/logo.png" alt="The RxJS Logo, a Ninja jumping over a moon"></p>
<p><a href="https://rxjs.ninja" target="_blank">RxJS Ninja</a>
 - is a collection of over 130 operators for working with various types of data (such
as <a href="https://rxjs.ninja/modules/array.html" target="_blank">arrays</a>
, <a href="https://rxjs.ninja/modules/number.html" target="_blank">numbers</a>
) and
<a href="https://rxjs.ninja/modules/utility.html#Streams" target="_blank">streams</a>
 allowing for modifying, filtering and querying the data.</p>
<p>Still in active development, you might find useful operators that provide clearer intent for your RxJS code.</p>
<p>You can check out the source code on <a href="https://github.com/rxjs-ninja/rxjs-ninja" target="_blank">GitHub</a>
.</p>
</div>
</div>

    
    <div class="post">
  <div class="post-heading">
    <h1>
      <a href="https://tane.dev/2021/01/creating-custom-rxjs-operators/">Creating Custom RxJS Operators</a>
    </h1>
    
      <div class="meta">
  <i class="far fa-calendar-edit" title="The date when this post was originally published" aria-label="The date when this post was originally published"></i><span>&nbsp;Published: Jan 25, 2021</span>
  
  &nbsp;<span title="The date I last noticed a typo" aria-label="The date I last noticed a typo">(last updated: Jan 27, 2021)</span>
  
  |&nbsp;<i class="far fa-pencil" title="The number of semi-coherent words I managed to produce" aria-label="The number of semi-coherent words I managed to produce"></i><span>~ 1500 words</span>
  |&nbsp;<i class="far fa-clock" title="Time is an illusion. Lunchtime doubly so" aria-label="Time is an illusion. Lunchtime doubly so"></i><span>~ 7 minutes reading time</span>
</div>

      
  <div class="tags" title="Click the links in this to go to a page based on a tag value" aria-label="Click the links in this to go to a page based on a tag value">
    
    <a class="flex-item" href="https://tane.dev/tags/typescript">TypeScript</a>
    
    <a class="flex-item" href="https://tane.dev/tags/rxjs">RxJS</a>
    
    <a class="flex-item" href="https://tane.dev/tags/observable">Observable</a>
    
    <a class="flex-item" href="https://tane.dev/tags/operators">Operators</a>
    
    <a class="flex-item" href="https://tane.dev/tags/ecmascript">ECMAScript</a>
    
    <a class="flex-item" href="https://tane.dev/tags/tutorial">Tutorial</a>
    
  </div>


      
        <div class="comments-link">
  <i
    class="far fa-comment-alt-lines"
    title="Read what the trolls have posted..."
    aria-label="Read what the trolls have posted..."
  ></i>&nbsp;<a href="https://tane.dev/2021/01/creating-custom-rxjs-operators/#commento">... comments</a>
</div>

      
    
  </div>
  <div class="post-content"><p><a href="https://rxjs.dev" target="_blank">RxJS</a>
 is a popular library available for <a href="https://www.typescriptlang.org/" target="_blank">TypeScript</a>
 and
JavaScript.</p>
<p>It provides APIs for the creation of applications and libraries using asynchronous streams of data and reactive methods.
It&rsquo;s one of the foundation libraries of <a href="https://angular.io" target="_blank">Angular</a>
.</p>
<p>Included in it are over 100 operators - functions that take an Observable stream of data and return values for use in
chains of operators.</p>
<p>Many of the operators are low level, and combining them through the <code>pipe</code> method they create a powerful way to work
with data.</p>
<h2 id="creating-custom-operators-for-a-domain">Creating custom operators for a domain</h2>
<p>The good news is it&rsquo;s also very easy to create new higher-level operators for our domain code - these can be used where
you find duplicate or complicated operations.</p>
<p>Creating operators we can also ensure well-tested code
using <a href="https://rxjs.dev/guide/testing/marble-testing" target="_blank">marble testing</a>
 and they can be shared among your team to make
your code more readable and stable.</p>
<p>There are two types of operators that can be created - a <code>MonoTypeOperatorFunction</code> and <code>OperatorFunction</code> and all
operators must do two things:</p>
<ul>
<li>Return a function which accepts as its parameter a source from the previous Observable value in the stream</li>
<li>Return a value of the same type for <code>MonoTypeOperatorFunction</code> or different type for an <code>OperatorFunction</code> by using
the source value with <code>pipe</code></li>
</ul>
<p>Below we&rsquo;ll have an example of each, but first, to support creating the operators we need some code to simplify:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">import</span> { <span style="color:#66d9ef">from</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;rxjs&#39;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">map</span>, <span style="color:#a6e22e">tap</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;rxjs/operators&#39;</span>;

<span style="color:#75715e">// Create a cold source that will emit each number
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">source$</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">from</span>([<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>]);

<span style="color:#75715e">// Create a cold source that multiplies each number by `5`
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">multiplyByFive$</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">source$</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">value</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span>));
<span style="color:#75715e">// Create a cold source that multiplies each number by `10`
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">multiplyByTen$</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">source$</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">value</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>));

<span style="color:#75715e">// Subscribe to the sources and console.log the output
</span><span style="color:#75715e"></span><span style="color:#a6e22e">multiplyByFive$</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">tap</span>(<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>)).<span style="color:#a6e22e">subscribe</span>();
<span style="color:#75715e">// Output: `5, 10, 15, 20, 25`
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">multiplyByTen$</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">tap</span>(<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>)).<span style="color:#a6e22e">subscribe</span>();
<span style="color:#75715e">// Output: `10, 20, 30, 40, 50`
</span></code></pre></td></tr></table>
</div>
</div><h2 id="creating-monotypeoperatorfunction-for-single-types">Creating MonoTypeOperatorFunction for single types</h2>
<p>As the name suggests a <code>MonoTypeOperatorFunction</code> is a function that works with a single type of data - the input and
output value <strong>must</strong> be of the same type.</p>
<p>Looking at our code we can identify two multiplication operations in our code that are the same. To turn this into an
operator the function will look like this:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">MonoTypeOperatorFunction</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;rxjs&#39;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">map</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;rxjs/operators&#39;</span>;

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">multiply</span>(<span style="color:#a6e22e">factor</span>: <span style="color:#66d9ef">number</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">MonoTypeOperatorFunction</span>&lt;<span style="color:#f92672">number</span>&gt; {
  <span style="color:#66d9ef">return</span> (<span style="color:#a6e22e">source</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">source</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">value</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">factor</span>))
}
</code></pre></td></tr></table>
</div>
</div><p>Here, we are returning an arrow function that takes the previous source - which must be an <code>Observable&lt;number&gt;</code>. The
source is piped to <a href="https://rxjs.dev/api/operators/map" target="_blank">map</a>
 which allows the source value to be converted to a new
value, in our case we multiply by the <code>factor</code></p>
<p>TypeScript understands that the output must also be a number - and if you try to return another value type it will throw
a compile error.</p>
<h3 id="writing-a-marble-test">Writing a marble test</h3>
<p><a href="https://rxjs.dev/guide/testing/marble-testing" target="_blank">Marble testing</a>
 is a way to write tests for RxJS operators that deal
with data over time - data is not static due to its asynchronous nature and cannot always be guaranteed in a specific
order. Luckily the test for this operator is simple.</p>
<blockquote>
<p>My personal preference has been to write these test in Jest using <a href="https://www.npmjs.com/package/rxjs-marbles" target="_blank">rxjs-marbles</a>
 and <a href="https://www.npmjs.com/package/jest-marbles" target="_blank">jest-marbles</a>
, but there are other libraries to write these test available.</p>
</blockquote>
<p>Using marbles, we can set up a mock source that will emit 5 numbers at the specified frames.</p>
<p>The test result contains two things:</p>
<ul>
<li>A subscriptions string which is used to check that the operator handle subscription ending properly
using <code>toHaveSubscriptions</code></li>
<li>An output Observable that will contain the results of the operator and compared against the expectations
using <code>toBeObservable</code></li>
</ul>
<p>In this test, we&rsquo;ll pass a source of numbers and multiply by <code>10</code></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">marbles</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;rxjs-marbles/jest&#34;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">map</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;rxjs/operators&#34;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">multiply</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;./multiply&#39;</span>

<span style="color:#a6e22e">describe</span>(<span style="color:#e6db74">&#34;multiply&#34;</span>, () <span style="color:#f92672">=&gt;</span> {
  <span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#34;should multiply by 10&#34;</span>, <span style="color:#a6e22e">marbles</span>(<span style="color:#a6e22e">m</span> <span style="color:#f92672">=&gt;</span> {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">input</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">hot</span>(<span style="color:#e6db74">&#39;-a-b-c-d-e-|&#39;</span>, {<span style="color:#a6e22e">a</span>: <span style="color:#66d9ef">2</span>, <span style="color:#a6e22e">b</span>: <span style="color:#66d9ef">3</span>, <span style="color:#a6e22e">c</span>: <span style="color:#66d9ef">4</span>, <span style="color:#a6e22e">d</span>: <span style="color:#66d9ef">5</span>, <span style="color:#a6e22e">e</span>: <span style="color:#66d9ef">6</span>});
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">subs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;^----------!&#39;</span>;
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">expected</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">cold</span>(<span style="color:#e6db74">&#39;-a-b-c-d-e-|&#39;</span>, {<span style="color:#a6e22e">a</span>: <span style="color:#66d9ef">20</span>, <span style="color:#a6e22e">b</span>: <span style="color:#66d9ef">30</span>, <span style="color:#a6e22e">c</span>: <span style="color:#66d9ef">40</span>, <span style="color:#a6e22e">d</span>: <span style="color:#66d9ef">50</span>, <span style="color:#a6e22e">e</span>: <span style="color:#66d9ef">60</span>});
    <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">expect</span>(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">mul</span>(<span style="color:#ae81ff">10</span>))).<span style="color:#a6e22e">toBeObservable</span>(<span style="color:#a6e22e">expected</span>);
    <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">expect</span>(<span style="color:#a6e22e">input</span>).<span style="color:#a6e22e">toHaveSubscriptions</span>(<span style="color:#a6e22e">subs</span>);
  }));
});
</code></pre></td></tr></table>
</div>
</div><h3 id="update-code">Update Code</h3>
<p>Now the operator is created it can be used in the existing code from above - ideally the operator should be part of a
shared library of code:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">import</span> { <span style="color:#66d9ef">from</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;rxjs&#39;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">multiply</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;@myorg/rxjs-library&#39;</span>

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">source$</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">from</span>([<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>]);

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">multiplyByFive$</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">source$</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">multiply</span>(<span style="color:#ae81ff">5</span>));
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">multiplyByTen$</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">source$</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">multiply</span>(<span style="color:#ae81ff">10</span>));
</code></pre></td></tr></table>
</div>
</div><p>Already much more readable! Our code explains our intent, but we haven&rsquo;t really reduced the duplication of our sources.</p>
<h2 id="changing-the-api-with-operatorfunction">Changing the API with OperatorFunction</h2>
<p>In our domain, we know we always want more than one value from a source and using the <code>OperatorFunction</code> we can use that
to reduce our duplicate code even more.</p>
<p>This would introduce an API change, but with proper tests, we should be able to migrate our code easily.</p>
<p>For our source value, it is still a single number value, but in the API we&rsquo;ve changed:</p>
<ul>
<li>The input <code>factor</code> can be a single value or an array of values</li>
<li>The return value is now an array of values, regardless of the input.</li>
</ul>
<p>Instead of forcing the users to check the type of response, this single API can be well documented and expected when we
use it in our code:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">OperatorFunction</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;rxjs&#39;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">map</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;rxjs/operators&#39;</span>;

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">multiply</span>(<span style="color:#a6e22e">factor</span>: <span style="color:#66d9ef">number</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">number</span>[])<span style="color:#f92672">:</span> <span style="color:#a6e22e">OperatorFunction</span>&lt;<span style="color:#f92672">number</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">number</span><span style="color:#960050;background-color:#1e0010">[]</span>&gt; {
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">source</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">source</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">value</span> <span style="color:#f92672">=&gt;</span> (Array.<span style="color:#a6e22e">isArray</span>(<span style="color:#a6e22e">factor</span>) <span style="color:#f92672">?</span> <span style="color:#a6e22e">factor</span> <span style="color:#f92672">:</span> [<span style="color:#a6e22e">factor</span>]).<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">f</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">f</span>)))
}
</code></pre></td></tr></table>
</div>
</div><h3 id="updating-the-tests">Updating the tests</h3>
<p>First, we need to update the existing test - here we only have to change the values in our <code>expected</code> Observable - we
now expect an array of numbers regardless of the input - but with a single value our array length will be <code>1</code></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#34;should multiply by 10&#34;</span>, <span style="color:#a6e22e">marbles</span>(<span style="color:#a6e22e">m</span> <span style="color:#f92672">=&gt;</span> {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">input</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">hot</span>(<span style="color:#e6db74">&#39;-a-b-c-d-e-|&#39;</span>, {<span style="color:#a6e22e">a</span>: <span style="color:#66d9ef">2</span>, <span style="color:#a6e22e">b</span>: <span style="color:#66d9ef">3</span>, <span style="color:#a6e22e">c</span>: <span style="color:#66d9ef">4</span>, <span style="color:#a6e22e">d</span>: <span style="color:#66d9ef">5</span>, <span style="color:#a6e22e">e</span>: <span style="color:#66d9ef">6</span>});
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">subs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;^----------!&#39;</span>;
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">expected</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">cold</span>(<span style="color:#e6db74">&#39;-a-b-c-d-e-|&#39;</span>, {<span style="color:#a6e22e">a</span><span style="color:#f92672">:</span> [<span style="color:#ae81ff">20</span>], <span style="color:#a6e22e">b</span><span style="color:#f92672">:</span> [<span style="color:#ae81ff">30</span>], <span style="color:#a6e22e">c</span><span style="color:#f92672">:</span> [<span style="color:#ae81ff">40</span>], <span style="color:#a6e22e">d</span><span style="color:#f92672">:</span> [<span style="color:#ae81ff">50</span>], <span style="color:#a6e22e">e</span><span style="color:#f92672">:</span> [<span style="color:#ae81ff">60</span>]});
  <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">expect</span>(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">mul</span>(<span style="color:#ae81ff">10</span>))).<span style="color:#a6e22e">toBeObservable</span>(<span style="color:#a6e22e">expected</span>);
  <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">expect</span>(<span style="color:#a6e22e">input</span>).<span style="color:#a6e22e">toHaveSubscriptions</span>(<span style="color:#a6e22e">subs</span>);
}));
</code></pre></td></tr></table>
</div>
</div><p>To ensure full coverage, we should also test for the case where were have an array input for the multiplication factor:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#34;should multiply by by 5 and 10&#34;</span>, <span style="color:#a6e22e">marbles</span>(<span style="color:#a6e22e">m</span> <span style="color:#f92672">=&gt;</span> {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">input</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">hot</span>(<span style="color:#e6db74">&#39;-a-b-c-d-e-|&#39;</span>, {<span style="color:#a6e22e">a</span>: <span style="color:#66d9ef">2</span>, <span style="color:#a6e22e">b</span>: <span style="color:#66d9ef">3</span>, <span style="color:#a6e22e">c</span>: <span style="color:#66d9ef">4</span>, <span style="color:#a6e22e">d</span>: <span style="color:#66d9ef">5</span>, <span style="color:#a6e22e">e</span>: <span style="color:#66d9ef">6</span>});
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">subs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;^----------!&#39;</span>;
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">expected</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">cold</span>(<span style="color:#e6db74">&#39;-a-b-c-d-e-|&#39;</span>, {<span style="color:#a6e22e">a</span><span style="color:#f92672">:</span> [<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>], <span style="color:#a6e22e">b</span><span style="color:#f92672">:</span> [<span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">30</span>], <span style="color:#a6e22e">c</span><span style="color:#f92672">:</span> [<span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">40</span>], <span style="color:#a6e22e">d</span><span style="color:#f92672">:</span> [<span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">50</span>], <span style="color:#a6e22e">e</span><span style="color:#f92672">:</span> [<span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">60</span>]});
  <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">expect</span>(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">mul</span>([<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>]))).<span style="color:#a6e22e">toBeObservable</span>(<span style="color:#a6e22e">expected</span>);
  <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">expect</span>(<span style="color:#a6e22e">input</span>).<span style="color:#a6e22e">toHaveSubscriptions</span>(<span style="color:#a6e22e">subs</span>);
}));
</code></pre></td></tr></table>
</div>
</div><h3 id="update-code-1">Update Code</h3>
<p>We can now update the code further - here we can now remove the two additional cold Observables and create a single one
using our new <code>multiply</code> operator, passing it an array containing out factors:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">import</span> { <span style="color:#66d9ef">from</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;rxjs&#39;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">multiply</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;@myorg/rxjs-library&#39;</span>

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">source$</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">from</span>([<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>]);

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">multiplyValues$</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">source$</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">multiply</span>([<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>]));
</code></pre></td></tr></table>
</div>
</div><p>Now we can subscribe to the <code>multiplyValues$</code> source and get both our new result which contains the multiplication of
both numbers</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#a6e22e">multiplyValues$</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">tap</span>(<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>)).<span style="color:#a6e22e">subscribe</span>();
<span style="color:#75715e">// Output: `[5, 10], [10, 20], [15, 30], [20, 40], [25, 50]`
</span></code></pre></td></tr></table>
</div>
</div><h2 id="next-steps">Next Steps</h2>
<p>You can see a working version of this operator
on <a href="https://stackblitz.com/edit/rxjs-create-custom-operator?file=index.ts" target="_blank">StackBlitz</a>
 by opening the console to see the
result.</p>
<p>This operator is just a taste of what&rsquo;s possible with RxJS - diving into the API you&rsquo;ll find many more operators to help
work with data in other synchronous and asynchronous operations.</p>
<h2 id="a-collection-of-pre-built-operators-for-your-projects">A collection of pre-built operators for your projects</h2>
<p><img src="https://raw.githubusercontent.com/rxjs-ninja/rxjs-ninja/main/assets/logo.png" alt="The RxJS Logo, a Ninja jumping over a moon"></p>
<p>Now for a shameless plug - my own library - <a href="https://rxjs.ninja" target="_blank">RxJS Ninja</a>
 - is a collection of over 130 operators for
working with various types of data (such as <a href="https://rxjs.ninja/modules/array.html" target="_blank">arrays</a>

or <a href="https://rxjs.ninja/modules/number.html" target="_blank">numbers</a>
) and <a href="https://rxjs.ninja/modules/utility.html#Streams" target="_blank">streams</a>

allowing for modifying, filtering and querying the data.</p>
<p>Still in active development, you might find useful operators that provide clearer intent for your RxJS code.</p>
<p>You can check out the source code on <a href="https://github.com/rxjs-ninja/rxjs-ninja" target="_blank">GitHub</a>
. There you can also find
a <a href="https://github.com/rxjs-ninja/nx-library-starter" target="_blank">starter project</a>
 for creating your own TypeScript libraries like
this.</p>
</div>
</div>

    
    <div class="post">
  <div class="post-heading">
    <h1>
      <a href="https://tane.dev/2021/01/rxjs-ninja-updates-new-operators-for-math-and-working-with-streams/">RxJS Ninja Updates - New operators for math and working with streams</a>
    </h1>
    
      <div class="meta">
  <i class="far fa-calendar-edit" title="The date when this post was originally published" aria-label="The date when this post was originally published"></i><span>&nbsp;Published: Jan 14, 2021</span>
  
  &nbsp;<span title="The date I last noticed a typo" aria-label="The date I last noticed a typo">(last updated: Jan 14, 2021)</span>
  
  |&nbsp;<i class="far fa-pencil" title="The number of semi-coherent words I managed to produce" aria-label="The number of semi-coherent words I managed to produce"></i><span>~ 300 words</span>
  |&nbsp;<i class="far fa-clock" title="Time is an illusion. Lunchtime doubly so" aria-label="Time is an illusion. Lunchtime doubly so"></i><span>~ 2 minutes reading time</span>
</div>

      
  <div class="tags" title="Click the links in this to go to a page based on a tag value" aria-label="Click the links in this to go to a page based on a tag value">
    
    <a class="flex-item" href="https://tane.dev/tags/typescript">TypeScript</a>
    
    <a class="flex-item" href="https://tane.dev/tags/rxjs">RxJS</a>
    
    <a class="flex-item" href="https://tane.dev/tags/npm">NPM</a>
    
    <a class="flex-item" href="https://tane.dev/tags/library">Library</a>
    
    <a class="flex-item" href="https://tane.dev/tags/ecmascript">ECMAScript</a>
    
  </div>


      
        <div class="comments-link">
  <i
    class="far fa-comment-alt-lines"
    title="Read what the trolls have posted..."
    aria-label="Read what the trolls have posted..."
  ></i>&nbsp;<a href="https://tane.dev/2021/01/rxjs-ninja-updates-new-operators-for-math-and-working-with-streams/#commento">... comments</a>
</div>

      
    
  </div>
  <div class="post-content"><p>Since the last update on <a href="https://rxjs.ninja" target="_blank">RxJS Ninja</a>
 there have been a few new operators added, below are some details
and links to StackBlitz demos showing them in action.</p>
<h3 id="numbers-and-math-operators">Numbers and Math operators</h3>
<p>In <code>@rxjs-ninja/rxjs-number</code> the missing <a href="https://rxjs.ninja/modules/number.html#tofixed" target="_blank">toFixed</a>
 operator has been
added, alongside a new custom <a href="https://rxjs.ninja/modules/number.html#tohex" target="_blank">toHex</a>
 operator and the
corresponding <a href="https://rxjs.ninja/modules/number.html#parsehex" target="_blank">parseHex</a>
 one allowing hex numbers to be worked with (
such as converting colours)</p>
<p>There are also new operators for some basic math - <a href="https://rxjs.ninja/modules/number.html#add" target="_blank">add</a>

, <a href="https://rxjs.ninja/modules/number.html#sub" target="_blank">sub</a>
, <a href="https://rxjs.ninja/modules/number.html#div" target="_blank">div</a>
,
<a href="https://rxjs.ninja/modules/number.html#mul" target="_blank">mul</a>
, <a href="https://rxjs.ninja/modules/number.html#mod" target="_blank">mod</a>
 and
<a href="https://rxjs.ninja/modules/number.html#pow" target="_blank">pow</a>
 all allowing you to modify source numbers, all accept a number, or an
Observable number source.</p>
<h3 id="working-with-browser-streams">Working with Browser Streams</h3>
<p>Some new operators have been added to <code>@rxjs-ninja/rxjs-utility</code> that allow interoperability between <a href="http://rxjs.dev" target="_blank">RxJS</a>

and the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Streams_API" target="_blank">StreamsAPI</a>
. These APIs are not in all browsers
but there is an available <a href="https://www.npmjs.com/package/web-streams-polyfill" target="_blank">polyfill</a>
.</p>
<h4 id="fromreadablestream"><code>fromReadableStream</code></h4>
<p>This <a href="https://rxjs.ninja/modules/utility.html#fromreadablestream" target="_blank">operator</a>
 accepts a <a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream" target="_blank">ReadableStream</a>

and provides the emitted values as an Observable, allowing you to use RxJS operators to work with the data.</p>
<ul>
<li><a href="https://stackblitz.com/edit/rxjs-readable-stream-fetch" target="_blank">Demo</a>
 - Using <code>fetch</code> body with <code>fromReadableStream</code> to show
partial images</li>
<li><a href="https://stackblitz.com/edit/rxjs-readable-stream" target="_blank">Demo</a>
 - A basic infinite number stream that ticks per second</li>
</ul>
<h4 id="towritablestream"><code>toWritableStream</code></h4>
<p>This <a href="https://rxjs.ninja/modules/utility.html#towritablestream" target="_blank">operator</a>
 accepts a <a href="https://developer.mozilla.org/en-US/docs/Web/API/WritableStream" target="_blank">WritableStream</a>
.
The operator emits the source value and also writes to the stream. The operator takes care of closing the writer when the
Observable subscription is closed.</p>
<ul>
<li><a href="https://stackblitz.com/edit/rxjs-writable-stream" target="_blank">Demo</a>
 - Streams an Observable interval value into a <code>WritableStream</code>
with optional ability to stop the writer without ending the Observable subscription.</li>
</ul>
<h4 id="fromfetchwithprogress"><code>fromFetchWithProgress</code></h4>
<p>This <a href="https://rxjs.ninja/modules/utility.html#fromfetchwithprogress" target="_blank">operator</a>
 uses <code>fetch</code> to do a HTTP request, instead
of the body response it emits either a <code>number</code> which is the current progress, or a <code>Uint8Array</code> containing the final
response from the body.</p>
<ul>
<li><a href="https://stackblitz.com/edit/fetch-with-progress" target="_blank">Demo</a>
 Fetches an image and shows a progress bar with the current percentage
and once complete shows the image.</li>
</ul>
</div>
</div>

    
    <div class="post">
  <div class="post-heading">
    <h1>
      <a href="https://tane.dev/2020/11/rxjs-primitives-is-now-rxjs-ninja/">RxJS Primitives is now RxJS Ninja</a>
    </h1>
    
      <div class="meta">
  <i class="far fa-calendar-edit" title="The date when this post was originally published" aria-label="The date when this post was originally published"></i><span>&nbsp;Published: Nov 23, 2020</span>
  
  &nbsp;<span title="The date I last noticed a typo" aria-label="The date I last noticed a typo">(last updated: Nov 23, 2020)</span>
  
  |&nbsp;<i class="far fa-pencil" title="The number of semi-coherent words I managed to produce" aria-label="The number of semi-coherent words I managed to produce"></i><span>~ 100 words</span>
  |&nbsp;<i class="far fa-clock" title="Time is an illusion. Lunchtime doubly so" aria-label="Time is an illusion. Lunchtime doubly so"></i><span>~ 1 minutes reading time</span>
</div>

      
  <div class="tags" title="Click the links in this to go to a page based on a tag value" aria-label="Click the links in this to go to a page based on a tag value">
    
    <a class="flex-item" href="https://tane.dev/tags/typescript">TypeScript</a>
    
    <a class="flex-item" href="https://tane.dev/tags/rxjs">RxJS</a>
    
    <a class="flex-item" href="https://tane.dev/tags/npm">NPM</a>
    
    <a class="flex-item" href="https://tane.dev/tags/library">Library</a>
    
    <a class="flex-item" href="https://tane.dev/tags/ecmascript">ECMAScript</a>
    
  </div>


      
        <div class="comments-link">
  <i
    class="far fa-comment-alt-lines"
    title="Read what the trolls have posted..."
    aria-label="Read what the trolls have posted..."
  ></i>&nbsp;<a href="https://tane.dev/2020/11/rxjs-primitives-is-now-rxjs-ninja/#commento">... comments</a>
</div>

      
    
  </div>
  <div class="post-content"><p><img src="https://raw.githubusercontent.com/rxjs-ninja/rxjs-ninja/main/assets/logo.png" alt="RxJS Ninja Logo is a Ninja jumping over a crescent moon"></p>
<p>Today I&rsquo;ve re-released RxJS Primitives as <a href="https://rxjs.ninja" target="_blank">RxJS Ninja</a>
. The new libraries have been published as the same last versions
under their old name, so it&rsquo;s easy to migrate to the new version - all now published under <code>@rxjs-ninja</code> instead of <code>@tinynodes</code>
(a deprecation notice has also been left the old packages).</p>
</div>
</div>

    

    <div class="text-center">
      
<ul class="pagination">
  <li class="page-item">
    <a href="https://tane.dev/" class="page-link" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
  </li>
  <li class="page-item disabled">
    <a  class="page-link" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
  </li>
  <li class="page-item active">
    <a class="page-link" href="https://tane.dev/">1</a>
  </li>
  <li class="page-item">
    <a class="page-link" href="https://tane.dev/blog/2/">2</a>
  </li>
  <li class="page-item">
    <a class="page-link" href="https://tane.dev/blog/3/">3</a>
  </li>
  <li class="page-item">
    <a href="https://tane.dev/blog/2/" class="page-link" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
  </li>
  <li class="page-item">
    <a href="https://tane.dev/blog/3/" class="page-link" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
  </li>
</ul>


    </div>
  </main>
</div>

</div>
    <footer></footer>




<script src="https://tane.dev/js/bundle.min.a035a604266b30159999a46dd819244c0e3a66e10a11fbee9f56e328e47b47d11341be8f083661a570f80852476f66f4f9a57af856c1a5cc80c34a0ab879ab05.js" integrity="sha512-oDWmBCZrMBWZmaRt2BkkTA46ZuEKEfvun1bjKOR7R9ETQb6PCDZhpXD4CFJHb2b0&#43;aV6&#43;FbBpcyAw0oKuHmrBQ==" defer></script>


  <script defer src="https://cdn.commento.io/js/count.js"></script>




    
  </body>
</html>
